{
  "comments": [
    "Tests covering the least function."
  ],
  "tests": [
    {
      "name": "least of ints incl. literals and nulls",
      "format": ["JSON"],
      "statements": [
        "CREATE STREAM INPUT (ID BIGINT KEY, N1 INT, N2 INT, N3 INT, N4 INT) WITH (kafka_topic='input_topic',value_format='{FORMAT}');",
        "CREATE STREAM OUTPUT AS SELECT ID, LEAST(N1, N2, N3, N4, null, null, 5) AS LOWEST FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": 1, "value": {"N1": 1, "N2": -1, "N3":  0, "N4": null}},
        {"topic": "input_topic", "key": 2, "value": {"N1": 2147483647, "N2": -2147483648, "N3":  0, "N4": null}},
        {"topic": "input_topic", "key": 3, "value": {"N1": null, "N2": null, "N3":  null, "N4": null}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 1, "value": {"LOWEST": -1}},
        {"topic": "OUTPUT", "key": 2, "value": {"LOWEST": -2147483648}},
        {"topic": "OUTPUT", "key": 3, "value": {"LOWEST": 5}}
      ]
    },

    {
      "name": "test implicit casting to long",
      "format": ["JSON"],
      "statements": [
        "CREATE STREAM INPUT (ID BIGINT KEY, N1 INT, N2 BIGINT) WITH (kafka_topic='input_topic',value_format='{FORMAT}');",
        "CREATE STREAM OUTPUT AS SELECT ID, LEAST(N1, N2, null) AS LOWEST FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": 1, "value": {"N1": 1, "N2": -1000000000000}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 1, "value": {"LOWEST": -1000000000000}}
      ]
    },

    {
      "name": "test implicit casting to decimal",
      "format": ["JSON"],
      "statements": [
        "CREATE STREAM INPUT1 (ID BIGINT KEY, N1 INT, N2 BIGINT, N3 DECIMAL(10,5)) WITH (kafka_topic='input_topic',value_format='{FORMAT}');",
        "CREATE STREAM INPUT2 (ID BIGINT KEY, N1 INT, N2 BIGINT, N3 DECIMAL(10,5)) WITH (kafka_topic='input_topic_2',value_format='{FORMAT}');",

        "CREATE STREAM OUTPUT1 AS SELECT ID, LEAST(N1, N2, N3, null) AS LOWEST FROM INPUT1;",
        "CREATE STREAM OUTPUT2 AS SELECT ID, LEAST(N1, N3, null) AS LOWEST FROM INPUT1;",
        "CREATE STREAM OUTPUT3 AS SELECT ID, LEAST(N2, N3, null) AS LOWEST FROM INPUT2;"

      ],
      "inputs": [
        {"topic": "input_topic", "key": 1, "value": {"N1": 1, "N2": -1000000000000, "N3": -99999.99999}},
        {"topic": "input_topic_2", "key": 1, "value": {"N1": -5000, "N2": 1000000000000, "N3": -999.99999}}
      ],
      "outputs": [
        {"topic": "OUTPUT1", "key": 1, "value": {"LOWEST": -1000000000000.00000}},
        {"topic": "OUTPUT2", "key": 1, "value": {"LOWEST": -99999.99999}},
        {"topic": "OUTPUT3", "key": 1, "value": {"LOWEST": -5000.00000}}

      ]
    },

    {
      "name": "test implicit casting to double",
      "format": ["JSON"],
      "statements": [
        "CREATE STREAM INPUT1 (ID BIGINT KEY, N1 INT, N2 BIGINT, N3 DECIMAL(10,5)) WITH (kafka_topic='input_topic',value_format='{FORMAT}');",
        "CREATE STREAM INPUT2 (ID BIGINT KEY, N1 INT, N2 BIGINT, N3 DECIMAL(10,5)) WITH (kafka_topic='input_topic_2',value_format='{FORMAT}');",

        "CREATE STREAM OUTPUT1 AS SELECT ID, LEAST(N1, N2, N3, null) AS LOWEST FROM INPUT1;",
        "CREATE STREAM OUTPUT2 AS SELECT ID, LEAST(N1, N3, null) AS LOWEST FROM INPUT1;",
        "CREATE STREAM OUTPUT3 AS SELECT ID, LEAST(N2, N3, null) AS LOWEST FROM INPUT2;"

      ],
      "inputs": [
        {"topic": "input_topic", "key": 1, "value": {"N1": 1, "N2": -1000000000000, "N3": -99999.99999}},
        {"topic": "input_topic_2", "key": 1, "value": {"N1": -5000, "N2": 1000000000000, "N3": -999.99999}}
      ],
      "outputs": [
        {"topic": "OUTPUT1", "key": 1, "value": {"LOWEST": -1000000000000.00000}},
        {"topic": "OUTPUT2", "key": 1, "value": {"LOWEST": -99999.99999}},
        {"topic": "OUTPUT3", "key": 1, "value": {"LOWEST": -5000.00000}}

      ]
    },

    {
      "name": "least of strings incl. literals and nulls",
      "format": ["JSON"],
      "statements": [
        "CREATE STREAM INPUT (ID BIGINT KEY, S1 STRING, S2 STRING, S3 STRING, S4 STRING) WITH (kafka_topic='input_topic',value_format='{FORMAT}');",
        "CREATE STREAM OUTPUT AS SELECT ID, LEAST(S1, S2, S3, S4, null, null, 'hello') AS LOWEST FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": 1, "value": {"S1": "apple", "S2": "banana", "S3": "aardvark",  "S4": null}},
        {"topic": "input_topic", "key": 2, "value": {"S1": null, "S2": null, "S3": null,  "S4": null}},
        {"topic": "input_topic", "key": 3, "value": {"S1": "apple", "S2": "Zebra", "S3": "aardvark",  "S4": null}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 1, "value": {"LOWEST": "aardvark"}},
        {"topic": "OUTPUT", "key": 2, "value": {"LOWEST": "hello"}},
        {"topic": "OUTPUT", "key": 3, "value": {"LOWEST": "Zebra"}}
      ]
    },

    {
      "name": "should handle characters the must be escaped in java",
      "format": ["JSON"],
      "statements": [
        "CREATE STREAM INPUT (ID BIGINT KEY, S1 STRING) WITH (kafka_topic='input_topic',value_format='{FORMAT}');",
        "CREATE STREAM OUTPUT1 AS SELECT ID, LEAST('\"', S1) AS LOWEST FROM INPUT;",
        "CREATE STREAM OUTPUT2 AS SELECT ID, LEAST('\\foo\"', S1) AS LOWEST FROM INPUT;"

      ],
      "inputs": [
        {"topic": "test_topic", "key": 1, "value": {"S1": "foo"}},
        {"topic": "test_topic", "key": 2, "value": {"S1": "!"}},
        {"topic": "test_topic", "key": 3, "value": {"S1": "bar"}},
        {"topic": "test_topic", "key": 4, "value": {"S1": "!"}}

      ],
      "outputs": [
        {"topic": "OUTPUT1", "key": 1, "value": {"LOWEST":"\""}},
        {"topic": "OUTPUT1", "key": 2, "value": {"LOWEST":"!"}},
        {"topic": "OUTPUT2", "key": 3, "value": {"LOWEST":"\\foo\""}},
        {"topic": "OUTPUT2", "key": 4, "value": {"LOWEST":"!"}}
      ]
    },
    {
      "name": "should handle characters the must be escaped in sql",
      "format": ["JSON"],
      "statements": [
        "CREATE STREAM INPUT (ID STRING KEY, S1 STRING) WITH (kafka_topic='test_topic', value_format='{FORMAT}');",
        "CREATE STREAM OUTPUT AS SELECT ID, LEAST('''', S1) AS LOWEST FROM INPUT;"
      ],
      "inputs": [
        {"topic": "test_topic", "key": 1, "value": {"S1": "foo"}},
        {"topic": "test_topic", "key": 2, "value": {"S1": "!"}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"THING":"'"}},
        {"topic": "OUTPUT", "value": {"THING":"!"}}
      ]
    }







  ]
}